# TICKET-FIX-PHASE-3-AUTO: Автоматическое исправление багов Фазы 3

**Дата создания:** 2025-12-28
**Приоритет:** КРИТИЧЕСКИЙ
**Фаза:** 3 - Миграция данных в Supabase
**Назначено:** Веб-агент (удаленный Claude Code)

---

## Инструкция для агента

### Шаг 1: Переключиться на ветку

```bash
git fetch origin
git checkout claude/setup-supabase-TUKCP
git pull origin claude/setup-supabase-TUKCP
```

### Шаг 2: Создать новую ветку для исправлений

```bash
git checkout -b claude/fix-phase-3-bugs-auto
```

---

## План диагностики и исправления

### ЭТАП 1: Диагностика (создать подробный отчет)

**Что сделать:**
1. Запустить `npm run dev` на `localhost:3000`
2. Протестировать каждый функционал вручную
3. Проверить консоль браузера на ошибки
4. Создать файл `PHASE_3_AUTO_DIAGNOSTIC.md` с:
   - Списком найденных багов
   - Стектрейсом ошибок
   - Гипотезами причин

**Что проверить:**
- [ ] Создание задачи через "+" кнопку
- [ ] Drag & Drop между колонками
- [ ] Кнопки навигации (Главная, Все задачи, Команда, Отчет)
- [ ] Редирект на /login для неавторизованных
- [ ] Статистика в header
- [ ] Сохранение данных после обновления страницы

---

### ЭТАП 2: Анализ кода

**Проблемы, которые уже известны:**

#### 1. Создание задач не обновляет UI немедленно

**Файлы:**
- `src/hooks/useBoardData.ts:194-218` (addTask функция)
- `src/widgets/board/ui/Board.tsx:40-41` (использует tasks, не optimisticTasks)

**Проблема:**
- `addTask` сохраняет в Supabase
- UI обновляется только через Realtime подписку
- Realtime может сработать с задержкой
- Задача появляется только после обновления страницы

**Решение:**
- Использовать optimistic updates
- Обновлять `setTasks` сразу после вызова insert
- Rollback при ошибке

#### 2. Drag & Drop не обновляет UI немедленно

**Файлы:**
- `src/hooks/useBoardData.ts:248-278` (moveTask функция)
- `src/widgets/board/ui/Board.tsx:74-123` (onDragOver)

**Проблема:**
- `moveTask` обновляет optimisticTasks
- Но Board.tsx использует `tasks` (не optimisticTasks)
- UI обновляется только через Realtime

**Решение:**
- Использовать optimisticTasks в Board.tsx
- Или обновлять tasks напрямую с optimistic updates

#### 3. Кнопки навигации не работают

**Файлы:**
- `src/widgets/sidebar/ui/Sidebar.tsx:66-101` (handleNavClick)

**Проблема:**
- Кнопки делают только console.log или alert
- Не меняют состояние приложения
- "Все задачи" не показывает все задачи

**Решение:**
- Либо реализовать функционал (маршрутизацию)
- Либо временно скрыть неиспользуемые кнопки
- Минимум: сделать так, чтобы кнопки что-то меняли

#### 4. Нет редиректа на /login

**Файлы:**
- `src/app/page.tsx`

**Проблема:**
- Неавторизованный пользователь попадает на главную
- Нет проверки `if (!user) redirect('/login')`

**Решение:**
- Добавить проверку в page.tsx
- Или использовать middleware

---

### ЭТАП 3: Исправление багов

**Порядок исправления:**

1. **В первую очередь:**
   - Исправить создание задач (optimistic updates)
   - Исправить drag & drop (использовать optimistic state)

2. **Во вторую очередь:**
   - Исправить редирект на /login
   - Исправить кнопки навигации

3. **В третью очередь:**
   - Проверить статистику
   - Проверить team modal

**Правила:**
- Минимум изменений
- Найти root cause, не делать временные правки
- Не сломать существующее

---

### ЭТАП 4: Тестирование

**Обязательные тесты:**

```bash
npm run test        # Unit тесты должны проходить
npm run build       # Build не должен падать
npm run dev         # Ручная проверка
```

**Ручная проверка:**
1. Создать задачу - должна появиться сразу
2. Перетащить задачу - должна переместиться сразу
3. Обновить страницу - данные должны сохраниться
4. Выйти - должен быть редирект на /login
5. Зайти снова - должен быть редирект на /

---

### ЭТАП 5: Запушить в GitHub

```bash
git add .
git commit -m "Fix phase 3 bugs: task creation, drag & drop, navigation"
git push origin claude/fix-phase-3-bugs-auto
```

---

## Критерии успеха

- [ ] Создание задачи работает немедленно (появляется сразу)
- [ ] Drag & Drop работает немедленно (перемещается сразу)
- [ ] После обновления страницы данные сохранены
- [ ] Редирект на /login работает
- [ ] Кнопки навигации либо работают, либо скрыты
- [ ] Все unit тесты проходят
- [ ] Build успешно
- [ ] Нет ошибок в консоли браузера

---

## Дополнительная информация

**GitHub Repo:** https://github.com/Lavr5000/0-KanBanDoska.git
**Current Branch:** claude/setup-supabase-TUKCP
**Supabase Project:** sqhtukwjmlaxuvemkydn

**Документация:**
- `tasks/roadmap-supabase-testing.md`
- `tasks/tickets/PHASE-3-BUGS-TICKET.md`
- `WORKFLOW.md`
- `PROGRESS.md`

---

## Отчет после выполнения

После завершения создайте файл `PHASE_3_AUTO_FIX_REPORT.md` с:

1. Списком исправленных багов
2. Списком найденных новых проблем (если есть)
3. Измененными файлами
4. Результатами тестов
